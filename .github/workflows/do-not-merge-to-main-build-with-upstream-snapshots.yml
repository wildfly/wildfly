name: Build with Upstream Undertow and WildFly Core Snapshots for WFLY-21381

on:
  workflow_dispatch:
    inputs:
      undertow-branch:
        description: "Undertow Branch"
        required: true
        default: "2.4.x"
        type: string
      wildfly-core-branch:
        description: "WildFly Core Branch"
        required: true
        default: "main"
        type: string

jobs:
  build-undertow:
    runs-on: ubuntu-latest
    outputs:
      undertow-version: ${{ steps.version.outputs.undertow-version }}
    steps:
      - name: Checkout Undertow
        uses: actions/checkout@v6
        with:
          repository: undertow-io/undertow
          ref: ${{ inputs.undertow-branch }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build Undertow
        run: mvn -B clean install -DskipTests -Dcheckstyle.skip=true -Denforcer.skip=true
      
      - id: version
        name: Get Undertow Version
        run: echo "undertow-version=$(mvn -B help:evaluate -Dexpression=project.version -DforceStdout -q)" >> $GITHUB_OUTPUT
      
      - name: Archive Undertow Maven Repository
        run: |
          cd ~
          find ./.m2/repository -type d -name "*SNAPSHOT" -print0 | xargs -0 tar -czf ~/undertow-maven-repository.tar.gz
      
      - name: Upload Undertow Maven Repository
        uses: actions/upload-artifact@v6
        with:
          name: undertow-maven-repository
          path: ~/undertow-maven-repository.tar.gz
          retention-days: 5

  build-wildfly-core:
    runs-on: ubuntu-latest
    needs: build-undertow
    outputs:
      wildfly-core-version: ${{ steps.version.outputs.wildfly-core-version }}
    steps:
      - name: Checkout WildFly Core
        uses: actions/checkout@v6
        with:
          repository: wildfly/wildfly-core
          ref: ${{ inputs.wildfly-core-branch }}
      
      - name: Download Undertow Maven Repository
        uses: actions/download-artifact@v6
        with:
          name: undertow-maven-repository
          path: .
      
      - name: Extract Undertow Maven Repository
        run: tar -xzf undertow-maven-repository.tar.gz -C ~
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build WildFly Core with Undertow ${{ needs.build-undertow.outputs.undertow-version }}
        run: mvn -B clean install -DskipTests -Dcheckstyle.skip=true -Denforcer.skip=true -Dversion.io.undertow=2.4.0.Alpha2-SNAPSHOT
      
      - id: version
        name: Get WildFly Core Version
        run: echo "wildfly-core-version=$(mvn -B help:evaluate -Dexpression=project.version -DforceStdout -q)" >> $GITHUB_OUTPUT
      
      - name: Archive WildFly Core Maven Repository
        run: |
          cd ~
          find ./.m2/repository -type d -name "*SNAPSHOT" -print0 | xargs -0 tar -czf ~/wildfly-core-maven-repository.tar.gz
      
      - name: Upload WildFly Core Maven Repository
        uses: actions/upload-artifact@v6
        with:
          name: wildfly-core-maven-repository
          path: ~/wildfly-core-maven-repository.tar.gz
          retention-days: 5

  build-wildfly:
    runs-on: ubuntu-latest
    needs: build-wildfly-core
    steps:
      - name: Checkout WildFly
        uses: actions/checkout@v6
      
      - name: Download WildFly Core Maven Repository
        uses: actions/download-artifact@v6
        with:
          name: wildfly-core-maven-repository
          path: .
      
      - name: Extract WildFly Core Maven Repository
        run: tar -xzf wildfly-core-maven-repository.tar.gz -C ~
      
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: 17
          distribution: 'temurin'
          cache: 'maven'
      
      - name: Build WildFly with WildFly Core ${{ needs.build-wildfly-core.outputs.wildfly-core-version }}
        run: mvn -B clean install -DskipTests -Dcheckstyle.skip=true -Denforcer.skip=true -Dversion.org.wildfly.core=${{ needs.build-wildfly-core.outputs.wildfly-core-version }}
      
      - name: Get WildFly Version
        id: version
        run: echo "wildfly-version=$(mvn -B help:evaluate -Dexpression=project.version -DforceStdout -q)" >> $GITHUB_OUTPUT
      
      - name: Archive WildFly Maven Repository
        run: |
          cd ~
          find ./.m2/repository -type d -name "*SNAPSHOT" -print0 | xargs -0 tar -czf ~/wildfly-maven-repository.tar.gz
      
      - name: Upload WildFly Maven Repository
        uses: actions/upload-artifact@v6
        with:
          name: wildfly-maven-repository
          path: ~/wildfly-maven-repository.tar.gz
          retention-days: 5
      
      - name: Build Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Undertow Version**: ${{ needs.build-undertow.outputs.undertow-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **WildFly Core Version**: ${{ needs.build-wildfly-core.outputs.wildfly-core-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **WildFly Version**: ${{ steps.version.outputs.wildfly-version }}" >> $GITHUB_STEP_SUMMARY
